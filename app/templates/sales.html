{% extends 'base.html' %}
{% block content %}
<h2 class="mt-2">Sales (By Auction Date)</h2>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
  <div id="saveToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="saveToastBody">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Filter Row (mobile-first) -->
<form class="mb-3" method="get" action="{{ url_for('main.sales') }}">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-sm-6 col-md-3">
      <label for="sales_date" class="form-label mb-1">Auction Date</label>
      <input type="date" id="sales_date" name="date" class="form-control" value="{{ date_val }}" required>
    </div>
    <div class="col-6 col-md-2 d-grid">
      <button type="submit" class="btn btn-secondary">Load Lots</button>
    </div>
    <!-- (Removed the old “+ Add Buyer” button from here) -->
  </div>
</form>

<form method="post" action="{{ url_for('main.sales') }}" id="salesForm">
  <input type="hidden" name="date" value="{{ date_val }}">

  <!-- Desktop table -->
  <div class="table-responsive d-none d-sm-block">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:120px;">Lot #</th>
          <th style="width:140px;">Total Boxes</th>
          <th>Buyer</th>
          <th style="width:160px;">Rate</th>
          <th style="width:120px;">Less</th>
        </tr>
      </thead>
      <tbody>
        {% if lots %}
          {% for row in lots %}
            {% set s = sales_map.get(row['lot_id']) %}
            <tr>
              <td>{{ row['lot_number'] }}</td>
              <td>{{ row['total_boxes'] }}</td>
              <td>
                <input
                  class="form-control buyer_search"
                  placeholder="Tap to select buyer…"
                  id="buyer_input_{{ row['lot_id'] }}"
                  {% if s and s['buyer_id'] %} data-prefill-id="{{ s['buyer_id'] }}"{% endif %}
                  autocomplete="off" readonly>
                <input type="hidden" name="buyer_id_{{ row['lot_id'] }}" id="buyer_id_{{ row['lot_id'] }}" value="{{ s['buyer_id'] if s else '' }}">
              </td>
              <td>
                <input type="number" step="0.01" inputmode="decimal" name="rate_{{ row['lot_id'] }}"
                       class="form-control" placeholder="Rate"
                       value="{{ '{:.2f}'.format(s['rate']) if s and s['rate'] is not none else '' }}">
              </td>
              <td>
                <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" name="less_{{ row['lot_id'] }}"
                       class="form-control" placeholder="0"
                       value="{{ s['less'] if s and s['less'] is not none else '0' }}">
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-muted">No lots found for {{ date_val }}.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Mobile card view (xs only) -->
  <div class="d-sm-none">
    {% if lots %}
      <div class="mobile-cards">
        {% for row in lots %}
          {% set s = sales_map.get(row['lot_id']) %}
          <div class="mobile-card">
            <div class="mc-row"><span class="mc-label">Lot #</span><span class="mc-value">{{ row['lot_number'] }}</span></div>
            <div class="mc-row"><span class="mc-label">Total Boxes</span><span class="mc-value">{{ row['total_boxes'] }}</span></div>

            <div class="mc-row">
              <span class="mc-label">Buyer</span>
              <div class="mc-value">
                <input
                  class="form-control buyer_search"
                  placeholder="Tap to select buyer…"
                  id="buyer_input_{{ row['lot_id'] }}"
                  {% if s and s['buyer_id'] %} data-prefill-id="{{ s['buyer_id'] }}"{% endif %}
                  autocomplete="off" readonly>
                <input type="hidden" name="buyer_id_{{ row['lot_id'] }}" id="buyer_id_{{ row['lot_id'] }}" value="{{ s['buyer_id'] if s else '' }}">
              </div>
            </div>

            <div class="mc-row">
              <span class="mc-label">Rate</span>
              <div class="mc-value">
                <input type="number" step="0.01" inputmode="decimal" name="rate_{{ row['lot_id'] }}"
                       class="form-control" placeholder="Rate"
                       value="{{ '{:.2f}'.format(s['rate']) if s and s['rate'] is not none else '' }}">
              </div>
            </div>

            <div class="mc-row">
              <span class="mc-label">Less</span>
              <div class="mc-value">
                <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" name="less_{{ row['lot_id'] }}"
                       class="form-control" placeholder="0"
                       value="{{ s['less'] if s and s['less'] is not none else '0' }}">
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">No lots found for {{ date_val }}.</div>
    {% endif %}
  </div>

  <!-- Spacer for the floating bar -->
  <div style="height: 88px;"></div>

  <!-- Floating Save Bar -->
  <div class="floating-save-bar">
    <div class="container d-flex align-items-center gap-3">
      <button type="submit" class="btn btn-primary w-100 w-sm-auto">Save</button>
    </div>
  </div>
</form>

<!-- Add Buyer Modal -->
<div class="modal fade" id="addBuyerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="buyerForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Buyer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="text" name="name" class="form-control mb-2" placeholder="Name" required>
        <input type="text" name="nick_name" class="form-control mb-2" placeholder="Nick Name (shown in auction)">
        <input type="text" name="location" class="form-control mb-2" placeholder="Location (Town/Market)">
        <input type="text" name="address" class="form-control mb-2" placeholder="Address (optional)">
        <input type="text" name="phone_number" class="form-control mb-2" placeholder="Phone (optional)">
        <div id="buyerModalError" class="text-danger small" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Buyer</button>
      </div>
    </form>
  </div>
</div>

<!-- Buyer Picker (like Driver/Farmer) -->
<div id="buyerPicker" class="picker-overlay" role="dialog" aria-modal="true" style="display:none">
  <div class="picker-panel">
    <div class="picker-header">
      <input id="buyerPickerSearch" type="text" autocomplete="off" placeholder="Search buyer…">
      <button id="buyerPickerClose" class="picker-close" aria-label="Close">✖</button>
    </div>
    <div id="buyerPickerList" class="picker-list"></div>
    <div class="picker-footer">
      <button id="buyerPickerAdd" class="btn btn-outline-secondary">+ Add Buyer</button>
      <button id="buyerPickerCancel" class="btn btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<style>
  /* --- Mobile cards for xs screens --- */
  .mobile-cards { display: grid; gap: .75rem; }
  .mobile-card {
    background: #fff; border: 1px solid #e9ecef; border-radius: .75rem; padding: .75rem;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
  }
  .mc-row { display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: .5rem; padding: .25rem 0; }
  .mc-label { font-size: .9rem; color: #6b7280; }
  .mc-value { font-weight: 500; }

  .floating-save-bar {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: #fff; border-top: 1px solid #dee2e6;
    box-shadow: 0 -2px 6px rgba(0,0,0,.05);
    padding: 8px 0; z-index: 1030;
  }
  @supports (padding: max(0px)) {
    .floating-save-bar { padding-bottom: max(8px, env(safe-area-inset-bottom)); }
  }

  @media (max-width: 576px) {
    .btn { padding: .65rem .9rem; font-size: 1rem; }
    input, select { font-size: 16px !important; } /* prevent iOS zoom */
    .table td, .table th { padding: .55rem; }
  }

  /* Picker styles (same vibe as entry page) */
  .picker-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:3000}
  .picker-panel{position:absolute;inset:6vh 4vw;background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);display:flex;flex-direction:column}
  .picker-header{display:flex;gap:8px;align-items:center;padding:12px;border-bottom:1px solid #e5e7eb}
  .picker-header input{flex:1;padding:10px 12px;border:1px solid #ced4da;border-radius:8px;font-size:16px}
  .picker-close{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer}
  .picker-list{overflow:auto;max-height:60vh}
  .picker-item{padding:12px 16px;border-bottom:1px solid #f1f3f5;cursor:pointer}
  .picker-item:hover,.picker-item.active{background:#f5f9ff}
  .picker-sub{color:#6c757d;font-size:13px;margin-left:6px}
  .picker-footer{display:flex;gap:10px;justify-content:flex-end;padding:10px 12px;border-top:1px solid #e5e7eb}
  @media(min-width:768px){.picker-panel{inset:10vh calc(50vw - 320px)}}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let buyersCache = [];
  let lastFocusedLotId = null;

  function fetchBuyers(q="") {
    const url = new URL("{{ url_for('main.api_buyers') }}", window.location.origin);
    if (q) url.searchParams.set("q", q);
    return fetch(url, { headers: { "Accept":"application/json" } }).then(r => r.json());
  }

  // --- Buyer Picker (like Driver/Farmer) ---
  const overlay = document.getElementById("buyerPicker");
  const searchEl = document.getElementById("buyerPickerSearch");
  const listEl   = document.getElementById("buyerPickerList");
  const closeBtn = document.getElementById("buyerPickerClose");
  const cancelBtn= document.getElementById("buyerPickerCancel");
  const addBtn   = document.getElementById("buyerPickerAdd");

  let pickerState = { items:[], active:-1, onSelect:null };

  function render(items) {
    listEl.innerHTML = "";
    if (!items || !items.length) {
      listEl.innerHTML = '<div class="picker-item text-muted" style="cursor:default">No matches</div>';
      return;
    }
    items.forEach((b, idx) => {
      const div = document.createElement("div");
      div.className = "picker-item" + (idx===pickerState.active ? " active" : "");
      div.tabIndex = 0;
      div.dataset.index = idx;
      const label = b.label || b.name || "";
      const sub = b.location || b.phone || b.phone_number || "";
      div.innerHTML = `<strong>${escapeHtml(label)}</strong>${sub ? `<span class="picker-sub">${escapeHtml(sub)}</span>` : ""}`;
      div.addEventListener("click", () => choose(idx));
      listEl.appendChild(div);
    });
  }
  function choose(i){
    const it = pickerState.items[i]; if(!it || !pickerState.onSelect) return;
    pickerState.onSelect(it);
    overlay.style.display = "none";
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function openBuyerPicker({ initial="", onSelect }) {
    pickerState = { items:[], active:-1, onSelect };
    overlay.style.display = "block";
    searchEl.value = initial || "";
    render([]);
    // initial fetch
    try {
      buyersCache = buyersCache.length ? buyersCache : await fetchBuyers("");
      const q = searchEl.value.trim();
      const list = (!q ? buyersCache : (await fetchBuyers(q)));
      pickerState.items = list;
      pickerState.active = list.length ? 0 : -1;
      render(list);
    } catch { render([]); }
    setTimeout(() => searchEl.focus(), 10);
  }

  function closePicker(){ overlay.style.display="none"; pickerState.onSelect=null; }
  closeBtn.addEventListener("click", closePicker);
  cancelBtn.addEventListener("click", closePicker);

  // live search
  let searchT = null;
  searchEl.addEventListener("input", () => {
    clearTimeout(searchT);
    searchT = setTimeout(async () => {
      const q = searchEl.value.trim();
      const list = (!q ? buyersCache : (await fetchBuyers(q).catch(()=>[])));
      pickerState.items = list; pickerState.active = list.length ? 0 : -1; render(list);
    }, 150);
  });

  overlay.addEventListener("keydown", (e) => {
    if (e.key === "Escape") { e.preventDefault(); closePicker(); }
    else if (e.key === "ArrowDown") { e.preventDefault(); pickerState.active = Math.min(pickerState.active+1, pickerState.items.length-1); render(pickerState.items); }
    else if (e.key === "ArrowUp") { e.preventDefault(); pickerState.active = Math.max(pickerState.active-1, 0); render(pickerState.items); }
    else if (e.key === "Enter" && pickerState.active >= 0) { e.preventDefault(); choose(pickerState.active); }
  });

  // “+ Add Buyer” inside picker opens the modal, then returns selection on success
  addBtn.addEventListener("click", () => {
    overlay.style.display = "none";
    const m = new bootstrap.Modal(document.getElementById("addBuyerModal"));
    m.show();
  });

  // Init Buyer fields (open picker on focus/click, prefill labels)
  async function initBuyerPickers() {
    // preload cache
    buyersCache = await fetchBuyers("").catch(()=>[]);
    // prefill existing selections
    document.querySelectorAll(".buyer_search").forEach(inp => {
      const lotId = inp.id.replace("buyer_input_", "");
      const hidden = document.getElementById("buyer_id_" + lotId);
      const preId = inp.dataset.prefillId || hidden.value;
      if (preId) {
        const found = buyersCache.find(b => String(b.id) === String(preId));
        if (found) inp.value = found.label || found.name || "";
      }
      const open = () => {
        lastFocusedLotId = lotId;
        openBuyerPicker({
          initial: inp.value,
          onSelect: (b) => {
            inp.value = b.label || b.name || "";
            hidden.value = b.id;
          }
        });
      };
      inp.addEventListener("focus", open);
      inp.addEventListener("click", open);
    });
  }

  // Add Buyer via AJAX (same as before, but also applies to last-focused field)
  const addBuyerModal = document.getElementById("addBuyerModal");
  addBuyerModal.addEventListener("show.bs.modal", () => {
    document.getElementById("buyerForm").reset();
    document.getElementById("buyerModalError").style.display = "none";
  });

  document.getElementById("buyerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = Object.fromEntries(new FormData(form).entries());
    const res = await fetch("{{ url_for('main.api_buyers') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      document.getElementById("buyerModalError").textContent = "Could not add buyer. Please check inputs.";
      document.getElementById("buyerModalError").style.display = "block";
      return;
    }

    const created = await res.json(); // {id, label, ...}
    if (!buyersCache.find(b => b.id === created.id)) buyersCache.push(created);

    if (lastFocusedLotId) {
      const inp = document.getElementById("buyer_input_" + lastFocusedLotId);
      const hid = document.getElementById("buyer_id_" + lastFocusedLotId);
      if (inp && hid) { inp.value = created.label || created.name || ""; hid.value = created.id; }
    }

    bootstrap.Modal.getInstance(addBuyerModal).hide();
  });

  // Save (unchanged)
  document.getElementById("salesForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const warn = [...document.querySelectorAll(".buyer_search")].some(inp => {
      const lotId = inp.id.replace("buyer_input_", "");
      const hid = document.getElementById("buyer_id_" + lotId);
      return (inp.value.trim().length > 0 && !hid.value);
    });
    if (warn && !confirm("Some Buyer fields aren’t selected. Continue and save only completed rows?")) {
      return;
    }

    const form = e.target;
    const formData = new FormData(form);
    const res = await fetch(form.action, {
      method: "POST",
      headers: { "X-Requested-With": "fetch" },
      body: formData
    });

    const body = document.getElementById("saveToastBody");
    const t = document.getElementById("saveToast");

    try {
      const data = await res.json();
      body.textContent = data.message || `Saved ${(data.created||0)+(data.updated||0)} sale(s): ${data.created||0} new, ${data.updated||0} updated.`;
      new bootstrap.Toast(t, { delay: 2200 }).show();
    } catch {
      body.textContent = "Could not save. Please try again.";
      t.classList.remove("bg-success"); t.classList.add("bg-danger");
      new bootstrap.Toast(t, { delay: 2500 }).show();
      setTimeout(() => { t.classList.remove("bg-danger"); t.classList.add("bg-success"); }, 2600);
    }
  });

  initBuyerPickers();
});
</script>
{% endblock %}
