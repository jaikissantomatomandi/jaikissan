{% extends 'base.html' %}
{% block content %}
<h2 class="mt-2">Sales (By Auction Date)</h2>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
  <div id="saveToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="saveToastBody">Saved.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Filter Row (mobile-first) -->
<form class="mb-3" method="get" action="{{ url_for('main.sales') }}">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-sm-6 col-md-3">
      <label for="sales_date" class="form-label mb-1">Auction Date</label>
      <input type="date" id="sales_date" name="date" class="form-control" value="{{ date_val }}" required>
    </div>
    <div class="col-6 col-md-2 d-grid">
      <button type="submit" class="btn btn-secondary">Load Lots</button>
    </div>
    <div class="col-6 col-md-2 d-grid">
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBuyerModal">
        + Add Buyer
      </button>
    </div>
    <div class="col-12">
      <small class="text-muted">New buyer fills into the last Buyer field you touched.</small>
    </div>
  </div>
</form>

<form method="post" action="{{ url_for('main.sales') }}" id="salesForm">
  <input type="hidden" name="date" value="{{ date_val }}">

  <!-- Responsive table that becomes cards on small screens -->
  <div class="table-responsive d-none d-sm-block">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:120px;">Lot #</th>
          <th style="width:140px;">Total Boxes</th>
          <th>Buyer</th>
          <th style="width:160px;">Rate</th>
          <th style="width:120px;">Less</th>
        </tr>
      </thead>
      <tbody>
        {% if lots %}
          {% for row in lots %}
            {% set s = sales_map.get(row['lot_id']) %}
            <tr>
              <td>{{ row['lot_number'] }}</td>
              <td>{{ row['total_boxes'] }}</td>
              <td>
                <input
                  class="form-control buyer_search"
                  placeholder="Start typing buyer…"
                  id="buyer_input_{{ row['lot_id'] }}"
                  {% if s and s['buyer_id'] %} data-prefill-id="{{ s['buyer_id'] }}"{% endif %}
                  autocomplete="off">
                <input type="hidden" name="buyer_id_{{ row['lot_id'] }}" id="buyer_id_{{ row['lot_id'] }}" value="{{ s['buyer_id'] if s else '' }}">
              </td>
              <td>
                <input type="number" step="0.01" inputmode="decimal" name="rate_{{ row['lot_id'] }}"
                       class="form-control" placeholder="Rate"
                       value="{{ '{:.2f}'.format(s['rate']) if s and s['rate'] is not none else '' }}">
              </td>
              <td>
                <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" name="less_{{ row['lot_id'] }}"
                       class="form-control" placeholder="0"
                       value="{{ s['less'] if s and s['less'] is not none else '0' }}">
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-muted">No lots found for {{ date_val }}.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Mobile card view (xs only) -->
  <div class="d-sm-none">
    {% if lots %}
      <div class="mobile-cards">
        {% for row in lots %}
          {% set s = sales_map.get(row['lot_id']) %}
          <div class="mobile-card">
            <div class="mc-row"><span class="mc-label">Lot #</span><span class="mc-value">{{ row['lot_number'] }}</span></div>
            <div class="mc-row"><span class="mc-label">Total Boxes</span><span class="mc-value">{{ row['total_boxes'] }}</span></div>

            <div class="mc-row">
              <span class="mc-label">Buyer</span>
              <div class="mc-value">
                <input
                  class="form-control buyer_search"
                  placeholder="Start typing buyer…"
                  id="buyer_input_{{ row['lot_id'] }}"
                  {% if s and s['buyer_id'] %} data-prefill-id="{{ s['buyer_id'] }}"{% endif %}
                  autocomplete="off">
                <input type="hidden" name="buyer_id_{{ row['lot_id'] }}" id="buyer_id_{{ row['lot_id'] }}" value="{{ s['buyer_id'] if s else '' }}">
              </div>
            </div>

            <div class="mc-row">
              <span class="mc-label">Rate</span>
              <div class="mc-value">
                <input type="number" step="0.01" inputmode="decimal" name="rate_{{ row['lot_id'] }}"
                       class="form-control" placeholder="Rate"
                       value="{{ '{:.2f}'.format(s['rate']) if s and s['rate'] is not none else '' }}">
              </div>
            </div>

            <div class="mc-row">
              <span class="mc-label">Less</span>
              <div class="mc-value">
                <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" name="less_{{ row['lot_id'] }}"
                       class="form-control" placeholder="0"
                       value="{{ s['less'] if s and s['less'] is not none else '0' }}">
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">No lots found for {{ date_val }}.</div>
    {% endif %}
  </div>

  <!-- Spacer so the floating bar doesn't cover the last rows -->
  <div style="height: 88px;"></div>

  <!-- Floating Save Bar -->
  <div class="floating-save-bar">
    <div class="container d-flex align-items-center gap-3">
      <button type="submit" class="btn btn-primary w-100 w-sm-auto">Save</button>
    </div>
  </div>
</form>

<!-- Add Buyer Modal -->
<div class="modal fade" id="addBuyerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="buyerForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Buyer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="text" name="name" class="form-control mb-2" placeholder="Name" required>
        <input type="text" name="nick_name" class="form-control mb-2" placeholder="Nick Name (shown in auction)">
        <input type="text" name="location" class="form-control mb-2" placeholder="Location (Town/Market)">
        <input type="text" name="address" class="form-control mb-2" placeholder="Address (optional)">
        <input type="text" name="phone_number" class="form-control mb-2" placeholder="Phone (optional)">
        <div id="buyerModalError" class="text-danger small" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Buyer</button>
      </div>
    </form>
  </div>
</div>

<style>
  /* --- Mobile cards for xs screens --- */
  .mobile-cards { display: grid; gap: .75rem; }
  .mobile-card {
    background: #fff; border: 1px solid #e9ecef; border-radius: .75rem; padding: .75rem;
    box-shadow: 0 1px 6px rgba(0,0,0,.04);
  }
  .mc-row { display: grid; grid-template-columns: 120px 1fr; align-items: center; gap: .5rem; padding: .25rem 0; }
  .mc-label { font-size: .9rem; color: #6b7280; }
  .mc-value { font-weight: 500; }

  /* Floating save bar pinned at bottom, under Bootstrap modals (z-index 1050) */
  .floating-save-bar {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: #fff; border-top: 1px solid #dee2e6;
    box-shadow: 0 -2px 6px rgba(0,0,0,.05);
    padding: 8px 0; z-index: 1030;
  }
  @supports (padding: max(0px)) {
    .floating-save-bar { padding-bottom: max(8px, env(safe-area-inset-bottom)); }
  }

  /* Touch-friendly defaults on small screens */
  @media (max-width: 576px) {
    .btn { padding: .65rem .9rem; font-size: 1rem; }
    input, select { font-size: 16px !important; } /* prevent iOS zoom */
    .table td, .table th { padding: .55rem; }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let buyersCache = [];
  let lastFocusedLotId = null;

  function fetchBuyers(q="") {
    const url = new URL("{{ url_for('main.api_buyers') }}", window.location.origin);
    if (q) url.searchParams.set("q", q);
    return fetch(url).then(r => r.json());
  }

  async function initBuyerPickers() {
    buyersCache = await fetchBuyers("");

    document.querySelectorAll(".buyer_search").forEach(inp => {
      const lotId = inp.id.replace("buyer_input_", "");
      const hidden = document.getElementById("buyer_id_" + lotId);

      inp.addEventListener("focus", () => { lastFocusedLotId = lotId; });

      const aw = new Awesomplete(inp, { minChars: 1, autoFirst: true });

      function setList(q) {
        const list = buyersCache
          .filter(b => !q || b.label.toLowerCase().includes(q.toLowerCase()))
          .map(b => b.label);
        aw.list = list;
      }
      setList("");

      const preId = inp.dataset.prefillId;
      if (preId) {
        const found = buyersCache.find(b => String(b.id) === String(preId));
        if (found) { inp.value = found.label; hidden.value = found.id; }
      }

      inp.addEventListener("input", async function () {
        const q = this.value.trim();
        setList(q);
        if (q.length) {
          const server = await fetchBuyers(q);
          server.forEach(s => { if (!buyersCache.find(b => b.id === s.id)) buyersCache.push(s); });
          setList(q);
        }
        hidden.value = "";
      });

      inp.addEventListener("awesomplete-selectcomplete", e => {
        const chosen = e.text.value || e.text;
        const match = buyersCache.find(b => b.label === chosen);
        hidden.value = match ? match.id : "";
      });
    });
  }

  // Create buyer via AJAX and insert into last-focused Buyer field
  const addBuyerModal = document.getElementById("addBuyerModal");
  addBuyerModal.addEventListener("show.bs.modal", () => {
    document.getElementById("buyerForm").reset();
    document.getElementById("buyerModalError").style.display = "none";
  });

  document.getElementById("buyerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = Object.fromEntries(new FormData(form).entries());
    const res = await fetch("{{ url_for('main.api_buyers') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      document.getElementById("buyerModalError").textContent = "Could not add buyer. Please check inputs.";
      document.getElementById("buyerModalError").style.display = "block";
      return;
    }

    const created = await res.json(); // {id, label, ...}
    // update cache + fill last-focused
    const existing = buyersCache.find(b => b.id === created.id);
    if (!existing) buyersCache.push(created);

    if (lastFocusedLotId) {
      const inp = document.getElementById("buyer_input_" + lastFocusedLotId);
      const hid = document.getElementById("buyer_id_" + lastFocusedLotId);
      if (inp && hid) {
        inp.value = created.label;
        hid.value = created.id;
      }
    }

    bootstrap.Modal.getInstance(addBuyerModal).hide();
  });

  // Single submit handler (AJAX save + toast)
  document.getElementById("salesForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Gentle warning if text typed but not selected
    const warn = [...document.querySelectorAll(".buyer_search")].some(inp => {
      const lotId = inp.id.replace("buyer_input_", "");
      const hid = document.getElementById("buyer_id_" + lotId);
      return (inp.value.trim().length > 0 && !hid.value);
    });
    if (warn && !confirm("Some Buyer fields aren’t selected. Continue and save only completed rows?")) {
      return;
    }

    const form = e.target;
    const formData = new FormData(form);
    const res = await fetch(form.action, {
      method: "POST",
      headers: { "X-Requested-With": "fetch" },
      body: formData
    });

    const body = document.getElementById("saveToastBody");
    const t = document.getElementById("saveToast");

    try {
      const data = await res.json();
      body.textContent = data.message || `Saved ${(data.created||0)+(data.updated||0)} sale(s): ${data.created||0} new, ${data.updated||0} updated.`;
      new bootstrap.Toast(t, { delay: 2200 }).show();
    } catch {
      body.textContent = "Could not save. Please try again.";
      t.classList.remove("bg-success"); t.classList.add("bg-danger");
      new bootstrap.Toast(t, { delay: 2500 }).show();
      setTimeout(() => { t.classList.remove("bg-danger"); t.classList.add("bg-success"); }, 2600);
    }
  });

  initBuyerPickers();
});
</script>
{% endblock %}
