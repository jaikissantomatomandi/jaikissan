{% extends 'base.html' %}
{% block content %}
<h2>Driver Entry + Lots</h2>
<form method="post" id="entryForm">
  <input type="hidden" name="date" id="form_date">

  <!-- Driver and Farmer Section -->
<div class="row g-2 mb-3">
  <div class="col-12 col-md-5">
    <input id="driver_search" name="driver_name" class="form-control" placeholder="Start typing driver..." required>
    <input type="hidden" name="driver_id" id="driver_id">
  </div>
  <div class="col-6 col-md-2 d-grid">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDriverModal">+ Driver</button>
  </div>
  <div class="col-6 col-md-2 d-grid">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFarmerModal">+ Farmer</button>
  </div>
  <div class="col-6 col-md-1">
    <input type="number" step="1" name="transport_rate" id="transport_rate" class="form-control" placeholder="₹/box" required>
  </div>
  <div class="col-6 col-md-2">
    <input type="date" id="entry_date" class="form-control" value="{{ today }}" required>
  </div>
</div>



  <!-- Lots Table -->
<div class="table-responsive">
  <table class="table table-bordered align-middle" id="lotsTable">
    <thead class="table-light">
      <tr>
        <th>Lot #</th><th>Farmer</th><th>JK</th><th>Other</th><th>+/-</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="lot_number_cell">1</td>
        <td>
<div class="d-flex">
  <input class="form-control farmer_search" name="farmer_name[]" required>
  <input type="hidden" name="farmer_id[]" class="farmer_id">
</div>
        </td>
        <td><input type="number" name="jk_boxes[]" class="form-control jk_boxes" min="0" required></td>
        <td><input type="number" name="other_boxes[]" class="form-control other_boxes" min="0" required></td>
        <td>
          <button type="button" class="btn btn-warning add-row">➕</button>
          <button type="button" class="btn btn-danger remove-row">✖</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>
  <button type="submit" class="btn btn-primary">Submit Entry</button>
</form>

<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" ...>
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="/add_driver_modal">
        <div class="modal-header">
          <h5 class="modal-title">Add New Driver</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="name" placeholder="Driver Name" class="form-control mb-2" required>
          <input type="text" name="vehicle_number" placeholder="Vehicle Number" class="form-control mb-2">
          <input type="text" name="village" placeholder="Village" class="form-control mb-2">
          <input type="number" step="0.01" name="default_rate" placeholder="Default Rate" class="form-control mb-2" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Driver</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Farmer Modal -->
<div class="modal fade" id="addFarmerModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/add_farmer_modal" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Farmer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" name="name" placeholder="Farmer Name" class="form-control mb-2" required>
        <input type="text" name="phone" placeholder="Phone" class="form-control mb-2">
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Add Farmer</button>
      </div>
    </form>
  </div>
</div>

<script>
let lotPrefix = "";
let lotCounter = 0;

function updateLotNumbers() {
  document.querySelectorAll("#lotsTable .lot_number_cell").forEach((cell, idx) => {
    const lotNum = lotPrefix + String(lotCounter + idx + 1).padStart(3, "0");
    cell.textContent = lotNum;
  });
}

function fetchLotStartNumber() {
  const date = document.getElementById("entry_date").value;
  if (!date) return;

  fetch("/api/next_lot_number?date=" + encodeURIComponent(date))
    .then(res => res.json())
    .then(data => {
      lotPrefix = data.prefix;
      lotCounter = data.last || 0;
      updateLotNumbers();
    });
}

document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("entryForm");
  const dateInput = document.getElementById("entry_date");
  fetchLotStartNumber();
  document.getElementById("form_date").value = dateInput.value;

  form.addEventListener("submit", function (e) {
    if (!document.getElementById("driver_id").value) {
      alert("Please select a valid Driver from the dropdown.");
      e.preventDefault();
      return;
    }
    const invalidFarmer = [...document.querySelectorAll(".farmer_id")].some(fid => !fid.value);
    if (invalidFarmer) {
      alert("Please select a valid Farmer from the dropdown.");
      e.preventDefault();
      return;
    }
    document.getElementById("form_date").value = dateInput.value;
  });

  dateInput.addEventListener("change", fetchLotStartNumber);

  function setupLotRow(row) {
    const farmerInput = row.querySelector(".farmer_search");
    const farmerIdInput = row.querySelector(".farmer_id");
    let farmerMap = {};
    const aw = new Awesomplete(farmerInput, { minChars: 1, autoFirst: true });

    farmerInput.addEventListener("input", function () {
      fetch("/api/farmers?q=" + encodeURIComponent(this.value))
        .then(res => res.json())
        .then(data => {
          farmerMap = {};
          aw.list = data.map(f => {
            const label = `${f.name} (${f.phone || ''})`;
            farmerMap[label] = f;
            return label;
          });
        });
    });

    farmerInput.addEventListener("awesomplete-selectcomplete", function (e) {
      const selected = farmerMap[e.text.value];
      if (selected) {
        farmerIdInput.value = selected.id;
      }
    });
  }

  const firstRow = document.querySelector("#lotsTable tbody tr");
  setupLotRow(firstRow);

  document.querySelector("#lotsTable").addEventListener("click", function (e) {
    if (e.target.classList.contains("add-row")) {
      const row = e.target.closest("tr");
      const newRow = row.cloneNode(true);
      newRow.querySelectorAll("input").forEach(input => input.value = "");
      newRow.querySelector(".lot_number_cell").textContent = "";
      row.after(newRow);
      setupLotRow(newRow);
      updateLotNumbers();
    } else if (e.target.classList.contains("remove-row")) {
      const row = e.target.closest("tr");
      const tbody = row.closest("tbody");
      if (tbody.rows.length > 1) {
        row.remove();
        updateLotNumbers();
      }
    }
  });

  const driverInput = document.getElementById("driver_search");
  const driverIdInput = document.getElementById("driver_id");
  const rateInput = document.getElementById("transport_rate");
  let driverMap = {};
  const awDriver = new Awesomplete(driverInput, { minChars: 1, autoFirst: true });

  driverInput.addEventListener("input", function () {
    fetch("/api/drivers?q=" + encodeURIComponent(this.value))
      .then(res => res.json())
      .then(data => {
        driverMap = {};
        awDriver.list = data.map(d => {
          const label = `${d.name} (${d.vehicle_number})`;
          driverMap[label] = d;
          return label;
        });
      });
  });

  driverInput.addEventListener("awesomplete-selectcomplete", function (e) {
    const selected = driverMap[e.text.value];
    if (selected) {
      driverIdInput.value = selected.id;
      rateInput.value = selected.default_rate || "";
    }
  });
});
</script>
{% endblock %}
